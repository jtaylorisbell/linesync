resources:
  alerts:
    open_replenishment_signals:
      display_name: "Open Replenishment Signals - ${bundle.target}"

      query_text: |
        -- Append-only pattern: get latest status per signal using window function
        WITH latest_signals AS (
          SELECT
            signal_id,
            status,
            ROW_NUMBER() OVER (PARTITION BY signal_id ORDER BY created_ts DESC) as rn
          FROM ${var.lakebase_catalog}.${var.lakebase_schema}.replenishment_signals
        )
        SELECT COUNT(*) as open_count
        FROM latest_signals
        WHERE rn = 1 AND status = 'OPEN'

      warehouse_id: 8d3e55aa7cea6427

      # Run every 5 minutes
      schedule:
        quartz_cron_schedule: "0 */5 * * * ?"
        timezone_id: "America/New_York"

      # Alert when count > 0
      evaluation:
        comparison_operator: "GREATER_THAN"
        source:
          name: "open_count"
          aggregation: "MAX"
          display: "open_count"
        threshold:
          value:
            double_value: 0
        notification:
          notify_on_ok: false
          retrigger_seconds: 0
          subscriptions:
            - destination_id: 7010c6e7-05c5-4ae9-8160-726f1f58a849

      custom_summary: "Replenishment Alert: {{ query_result.open_count }} open signals"
      custom_description: |
        There are {{ query_result.open_count }} open replenishment signals that need attention.
        Please review and fulfill these signals to maintain inventory levels.
